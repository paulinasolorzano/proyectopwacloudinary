<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#ffffff">
  <title>Proyectos 2 — PWA + Firebase (Firestore + Cloudinary)</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <style>
    body { background:#f7f7f7; }
    .thumbs-grid { display:grid; grid-template-columns: repeat(3, 1fr); gap: .5rem; }
    .thumb { object-fit: cover; height: 80px; border-radius: .5rem; }
  </style>
</head>
<body class="pb-5">

<nav class="navbar navbar-light bg-white border-bottom sticky-top">
  <div class="container">
    <span class="navbar-brand mb-0 h1">Proyectos 2 • Firestore + Cloudinary</span>
    <div class="d-flex gap-2">
      <button class="btn btn-outline-secondary" id="installBtn" hidden>Instalar</button>
      <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#proyectoModal">
        <i class="bi bi-plus-lg"></i> Nuevo proyecto
      </button>
    </div>
  </div>
</nav>

<main class="container mt-4">
  <div id="alertConfig" class="alert alert-warning d-none">
    <strong>Configura Firebase:</strong> Abre <code>index.html</code> y pega tu <em>firebaseConfig</em>.
  </div>

  <div id="projectsContainer" class="row"></div>
</main>

<footer class="text-center text-muted mt-4 small">
  <div class="container py-4">
    PWA con Firestore para datos + Cloudinary para imágenes. Modo offline activado.
  </div>
</footer>

<!-- Modal -->
<div class="modal fade" id="proyectoModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Nuevo proyecto</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form id="proyectoForm">
      <div class="modal-body">
        <div class="row g-3">
          <div class="col-md-6">
            <label class="form-label">Nombre del proyecto</label>
            <input id="nombreProyecto" class="form-control" required />
          </div>
          <div class="col-md-6">
            <label class="form-label">Cliente</label>
            <input id="clienteProyecto" class="form-control" required />
          </div>

          <div class="col-md-6">
            <label class="form-label">Fecha de inicio</label>
            <input type="date" id="fechaInicio" class="form-control" required />
          </div>
          <div class="col-md-6">
            <label class="form-label">Fecha de fin</label>
            <input type="date" id="fechaFin" class="form-control" required />
          </div>

          <div class="col-md-6">
            <label class="form-label">Presupuesto (MXN)</label>
            <input type="number" step="0.01" id="presupuesto" class="form-control" required />
          </div>
          <div class="col-md-6">
            <label class="form-label">Estado</label>
            <select id="estadoProyecto" class="form-select" required>
              <option value="planificacion">Planificación</option>
              <option value="en-progreso">En Progreso</option>
              <option value="en-pausa">En Pausa</option>
              <option value="completado">Completado</option>
            </select>
          </div>

          <div class="col-md-6">
            <label class="form-label">Responsable</label>
            <input id="responsable" class="form-control" required />
          </div>
          <div class="col-12">
            <label class="form-label">Descripción</label>
            <textarea id="descripcion" class="form-control" rows="2" placeholder="Notas, alcance, entregables…"></textarea>
          </div>
          <div class="col-12">
            <label class="form-label">Imágenes (opcional)</label>
            <input type="file" id="imagenes" class="form-control" accept="image/*" multiple />
            <div class="form-text">
              Se subirán a un servicio externo (Cloudinary) y solo se guardará la URL en Firestore.
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button class="btn btn-primary" type="submit">Guardar</button>
      </div>
      </form>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script type="module">
  // ------------------ Configuración Firebase ------------------
  // Sustituye con TU configuración real
  const firebaseConfig = {
    apiKey: "AIzaSyCfj0zE4_zPwinnTEC5rw1EqFzpMo1iP-0",
  authDomain: "friendly-retina-293203.firebaseapp.com",
  databaseURL: "https://friendly-retina-293203.firebaseio.com",
  projectId: "friendly-retina-293203",
  storageBucket: "friendly-retina-293203.appspot.com",
  messagingSenderId: "818178969253",
  appId: "1:818178969253:web:22ad49913a7347c371474c",
  measurementId: "G-8QS2ZB4BM4"
  };
  // -----------------------------------------------------------

  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
  import { 
    getFirestore, collection, addDoc, serverTimestamp,
    onSnapshot, query, orderBy, deleteDoc, doc,
    enableIndexedDbPersistence, updateDoc
  } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

  // Validar config
  const isConfigComplete = Object.values(firebaseConfig).every(
    v => typeof v === 'string' && v && !v.includes("TU_PROYECTO") && !v.includes("TU_API_KEY") && !v.includes("XXX")
  );
  if (!isConfigComplete) {
    document.getElementById('alertConfig').classList.remove('d-none');
  }

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  // Cache offline Firestore
  enableIndexedDbPersistence(db).catch(() => {});

  // ------------------ Cloudinary (frontend) ------------------
  // Usa los datos de tu cuenta:
  const cloudName = "TU_CLOUD_NAME";     // ej: "dghzl1j6g"
  const uploadPreset = "pwa_unsigned";   // el preset unsigned que creaste
  // -----------------------------------------------------------

  const modal = new bootstrap.Modal(document.getElementById('proyectoModal'));
  const form = document.getElementById('proyectoForm');
  const container = document.getElementById('projectsContainer');

  function currencyMX(n){
    return Number(n||0).toLocaleString('es-MX',{
      minimumFractionDigits:2,
      maximumFractionDigits:2
    });
  }

  function renderProjects(proyectos) {
    container.innerHTML = '';
    const estadoClasses = { planificacion:'info', 'en-progreso':'primary', 'en-pausa':'warning', completado:'success' };
    const estadoTexto   = { planificacion:'Planificación', 'en-progreso':'En Progreso', 'en-pausa':'En Pausa', completado:'Completado' };

    proyectos.forEach(p => {
      const col = document.createElement('div');
      col.className = 'col-md-6 col-lg-4 mb-4';

      const thumbs = (p.imagenes || []).slice(0,3)
        .map(u=>`<img class="thumb w-100" src="${u}" alt="${p.nombre}">`)
        .join('');
      const extra = (p.imagenes?.length||0) - 3;

      col.innerHTML = `
        <div class="card h-100 shadow-sm">
          <div class="card-header bg-${estadoClasses[p.estado]} text-white d-flex align-items-center justify-content-between">
            <h5 class="card-title mb-0">${p.nombre}</h5>
            <button class="btn btn-sm btn-light" data-action="delete" data-id="${p._id}" title="Eliminar">
              <i class="bi bi-trash3"></i>
            </button>
          </div>
          <div class="card-body">
            <p class="card-text mb-2">
              <strong>Cliente:</strong> ${p.cliente}<br>
              <strong>Responsable:</strong> ${p.responsable}<br>
              <strong>Presupuesto:</strong> $${currencyMX(p.presupuesto)}<br>
              <strong>Inicio:</strong> ${p.fechaInicio ? new Date(p.fechaInicio).toLocaleDateString('es-MX'): '-'}<br>
              <strong>Fin:</strong> ${p.fechaFin ? new Date(p.fechaFin).toLocaleDateString('es-MX'): '-'}
            </p>
            ${p.descripcion ? `<p class="card-text text-muted"><small>${p.descripcion}</small></p>` : ''}
            ${
              (p.imagenes && p.imagenes.length)
              ? `<div class="thumbs-grid">${thumbs}</div>${extra>0?`<div class="mt-2"><span class="badge bg-secondary">+${extra} más</span></div>`:''}`
              : '<div class="text-muted"><em>Sin imágenes</em></div>'
            }
          </div>
          <div class="card-footer">
            <span class="badge bg-${estadoClasses[p.estado]} w-100">${estadoTexto[p.estado]}</span>
          </div>
        </div>`;
      container.appendChild(col);
    });

    container.querySelectorAll('[data-action="delete"]').forEach(btn => {
      btn.addEventListener('click', async (e) => {
        const id = e.currentTarget.getAttribute('data-id');
        if (id && confirm('¿Eliminar proyecto?')) {
          await deleteDoc(doc(db,'proyectos', id));
        }
      });
    });
  }

  const proyectosRef = collection(db, 'proyectos');
  const q = query(proyectosRef, orderBy('createdAt','desc'));

  onSnapshot(q, (snap) => {
    const arr = snap.docs.map(d => ({ _id: d.id, ...d.data() }));
    renderProjects(arr);
  });

  // -------- Subir imágenes a Cloudinary y guardar URLs --------
  async function uploadImagesToCloudinary(files, idProyecto) {
    const list = Array.from(files || []);
    const urls = [];

    for (const file of list) {
      const formData = new FormData();
      formData.append("file", file);
      formData.append("upload_preset", uploadPreset);
      formData.append("folder", `proyectos/${idProyecto}`);

      const res = await fetch(`https://api.cloudinary.com/v1_1/${cloudName}/image/upload`, {
        method: "POST",
        body: formData
      });

      const data = await res.json();

      if (data.secure_url) {
        urls.push(data.secure_url);
      } else {
        console.error("Error al subir imagen a Cloudinary", data);
      }
    }

    return urls;
  }
  // ------------------------------------------------------------

  form.addEventListener('submit', async (e) => {
    e.preventDefault();

    const nombre       = document.getElementById('nombreProyecto').value.trim();
    const cliente      = document.getElementById('clienteProyecto').value.trim();
    const fechaInicio  = document.getElementById('fechaInicio').value;
    const fechaFin     = document.getElementById('fechaFin').value;
    const presupuesto  = parseFloat(document.getElementById('presupuesto').value || '0');
    const estado       = document.getElementById('estadoProyecto').value;
    const responsable  = document.getElementById('responsable').value.trim();
    const descripcion  = document.getElementById('descripcion').value.trim();
    const imgsInput    = document.getElementById('imagenes');

    // Crear documento base
    const docRef = await addDoc(proyectosRef, {
      nombre,
      cliente,
      fechaInicio,
      fechaFin,
      presupuesto,
      estado,
      responsable,
      descripcion,
      imagenes: [],
      createdAt: serverTimestamp()
    });

    // Subir imágenes (si hay) a Cloudinary y actualizar Firestore
    if (imgsInput.files && imgsInput.files.length) {
      const urls = await uploadImagesToCloudinary(imgsInput.files, docRef.id);
      if (urls.length) {
        await updateDoc(doc(db, 'proyectos', docRef.id), { imagenes: urls });
      }
    }

    e.target.reset();
    modal.hide();
  });

  // PWA install prompt
  let deferredPrompt;
  const installBtn = document.getElementById('installBtn');
  window.addEventListener('beforeinstallprompt', (e) => {
    e.preventDefault();
    deferredPrompt = e;
    installBtn.hidden = false;
  });
  installBtn?.addEventListener('click', async () => {
    installBtn.hidden = true;
    deferredPrompt?.prompt();
    await deferredPrompt?.userChoice;
    deferredPrompt = null;
  });

  // SW registration
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('./sw.js');
  }
</script>

</body>
</html>
